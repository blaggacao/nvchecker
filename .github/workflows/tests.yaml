name: run tests
on: [push, pull_request]
jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version:
        - "3.12"
        # pypy fails in some cases but we don't care much about that
        # with github actions we can't mark some jobs to not affect the overall
        # conclusion so we have to omit "allow-failure" tests.
        # See https://github.com/actions/toolkit/issues/399
        # - pypy-3.7
        deps:
        - tornado pycurl
        exclude: []
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Setup Cache
      uses: actions/cache@v3
      env:
        cache-name: cache-pip
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-${{ env.cache-name }}-${{ matrix.deps }}-${{ hashFiles('pyproject.toml', 'setup.cfg') }}
        restore-keys: |
          ${{ runner.os }}-${{ env.cache-name }}-${{ matrix.deps }}-
          ${{ runner.os }}-${{ env.cache-name }}-
    - name: Install pycurl deps
      if: ${{ contains(matrix.deps, 'pycurl') }}
      run: |
        sudo apt update
        sudo apt install -y libcurl4-openssl-dev
    # werkzeug is pinned for httpbin compatibility https://github.com/postmanlabs/httpbin/issues/673
    - name: Install Python deps
      run: pip install -U ${{ matrix.deps }} pytest 'pytest-asyncio>=0.23' pytest-httpbin flaky structlog tomli platformdirs lxml 'werkzeug<2.1' awesomeversion
    - name: Setup upterm session
      uses: lhotari/action-upterm@v1
      with:
        ## limits ssh access and adds the ssh public key for the user which triggered the workflow
        limit-access-to-actor: true
        ## limits ssh access and adds the ssh public keys of the listed GitHub users
        limit-access-to-users: lilydjwg
